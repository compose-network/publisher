# Compose Rollup Tooling — Progress Log

_Last updated: 2025-09-24_

## Context
- Repository provisions dual "Compose" rollups (A & B) that settle to Hoodi L1. Original bootstrap flow lived in `scripts/setup.sh` (~1.2k lines of Bash + embedded Python snippets) invoked by `./local` shell wrapper.
- Goals: simplify setup, reduce optional env churn, and make the pipeline maintainable so optimisations (parallelism, caching) can be added later.
- Constraints: keep existing Docker topology (`docker-compose.yml`), respect `.env` contract (HOODI RPC + funded wallet), and ensure fresh deployments still work with either live L1 (`DEPLOYMENT_TARGET=live`) or calldata-only mode.

## High-Level Design (as of today)
- New Typer-based CLI: `compose.py` (Python 3.13 under `.venv/`). Subcommands live in `scripts/`:
  - `up` orchestrates bootstrap/start.
  - `down`, `status`, `logs`, `restart`, `deploy`, `purge` mirror/extend prior `./local` behaviour.
- `scripts/up/__init__.py` wires modular steps:
  1. `environment.py` → load `.env`/`toolkit.env`, derive defaults, build `BootstrapContext`. Environment variables now allow process-level overrides (e.g. `DEPLOYMENT_TARGET`).
  2. `repositories.py` → ensure repos/contract bundle, honour `--fresh` by clearing `networks/`, `state/`, `.cache/genesis-go`, seed placeholder contract metadata.
  3. `op_deployer.py` → build/run op-deployer, generate genesis/rollup artefacts, compute L2 genesis hash (via Go helper), write Blockscout configs, capture L1 addresses, ensure JWT/password.
  4. `docker.py` → rebuild images when sources changed or bootstrap requested, start only core services (Blockscout left out for now).
  5. `contracts.py` → optional helper deployment (Foundry via Docker) with warmup wait + retry logic (currently limited to repeated RPC indexing checks).
- Shared utilities (`scripts/common.py`) handle logging, docker subprocesses, eth RPC probes, and safe removal (with Docker fallback for permission issues).
- Static rollup RPC/WS/health ports are defined in `scripts/up/__init__.py` instead of `.env` knobs (`ROLLUP_A_RPC_URL`, etc.).

## Current Status
- Python CLI scaffolding is in place and working for non-contract workflows.
  - `DEPLOYMENT_TARGET=calldata .venv/bin/python compose.py up --fresh --skip-contracts` completes successfully.
- `compose.py status` now summarises service health (including RPC block heights) and no longer crashes. When services are intentionally disabled (e.g., calldata runs), it reads `networks/bootstrap-meta.json` and skips RPC probes with an explicit note.
  - `compose.py purge --force` removes generated artefacts, leveraging a Docker cleanup fallback for root-owned cache files.
- Full contract deployment (`compose.py up --fresh`) now succeeds consistently when services run. If op-geth returns `transaction indexing is in progress`, we reuse the broadcast artifacts generated by Forge instead of failing the bootstrap. When `DEPLOYMENT_TARGET=calldata` the CLI skips service startup (and therefore helper deployment) unless `COMPOSE_FORCE_SERVICES=1` is present.
- `docker/up` step now starts only core services; Blockscout configs are still generated but containers are not launched by default (matches previous behaviour).
- Environment simplification: `.env` no longer needs RPC URLs for rollups/blockscout; only Hoodi RPC + wallet/sequencer credentials matter.

## Outstanding Issues / Next Steps
1. **Calldata vs live target**
   - `DEPLOYMENT_TARGET` now read from environment first, then `.env`. In calldata mode we skip docker startup by default; investigate a lightweight way to deploy helper contracts without requiring the full stack or clarify docs further.
2. **Genesis hash consistency**
   - After bootstrap, op-geth’s block 0 hash matches exported genesis. Keep validating when tweaking op-deployer flow.
3. **Blockscout**
   - Currently not started. Decide whether to reintroduce optional start command once bootstrap stabilises.
4. **Documentation & UX**
   - Update README once new CLI is the primary interface; include installation instructions (`python -m venv`, Typer commands, env var expectations).
   - Consider exposing useful flags: `--skip-contracts`, `--fresh`, `--timeout-minutes`, etc., in help text.
5. **Future simplifications**
   - Evaluate whether we can stop copying the shared publisher (now occurs only if dest missing).
   - Investigate caching for Foundry installs (`lib/` persisted across runs) and Go build caches.

## Getting Started (for new contributors)
1. Install dependencies: `python3 -m venv .venv && .venv/bin/pip install typer rich python-dotenv`.
2. Ensure `.env` provides Hoodi RPC + funded wallet + CL RPC (same as old workflow). No need to set rollup RPC URLs.
3. Typical bootstrap (no L1 writes):
   ```sh
   DEPLOYMENT_TARGET=calldata .venv/bin/python compose.py up --fresh --skip-contracts
   .venv/bin/python compose.py status
   ```
4. Full workflow (with helper contracts):
   ```sh
   COMPOSE_FORCE_SERVICES=1 DEPLOYMENT_TARGET=calldata .venv/bin/python compose.py up --fresh
   ```
   If Forge reports `transaction indexing is in progress`, check `/contracts/artifacts/deploy-rollup-*.json` and rerun with `--resume` only if those files are missing.
   Without `COMPOSE_FORCE_SERVICES=1`, calldata runs produce artifacts only and skip contract deployment; forcing services in calldata mode currently yields op-node/batcher/proposer exits because Hoodi state is absent.
5. Tear down & cleanup:
   ```sh
   .venv/bin/python compose.py down
   .venv/bin/python compose.py purge --force
   ```

Keep this document updated as the bootstrap pipeline evolves.

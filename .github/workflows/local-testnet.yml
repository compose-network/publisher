name: Secure Local Testnet on PR Comment

# This workflow is designed for restricted GitHub runners that only allow
# actions from the compose-network/github-actions repository.
# All steps use composite actions from this repo to prevent malicious code execution.

on:
  issue_comment:
    types: [created]

jobs:
  run-testnet:
    runs-on: public-isolated
    # Only run if the comment is on a PR, contains /test, and user is org member
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/test') &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER')
    permissions:
      contents: read
      issues: write
      pull-requests: write
      statuses: write
    steps:
      # Step 1: Add reaction to comment (uses our action)
      - name: Add reaction to comment
        uses: compose-network/github-actions/actions/add-reaction@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ github.event.comment.id }}
          reaction: 'rocket'

      # Step 2: Get PR information (uses our action)
      - name: Get PR info
        id: pr-info
        uses: compose-network/github-actions/actions/get-pr-info@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.issue.number }}

      # Step 3: Checkout PR code (uses our action)
      - name: Checkout PR code
        uses: compose-network/github-actions/actions/checkout-pr@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.issue.number }}

      # Step 4: Run local testnet (uses our action)
      - name: Run local testnet
        uses: compose-network/github-actions/actions/local-testnet@main
        with:
          # Required: Repository branches
          op-geth-branch: 'stage'
          publisher-branch: ${{ steps.pr-info.outputs.branch }}

          # Optional: Override Docker image tag
          # local-testnet-image-tag: 'v1.2.3'

          # PR information for status updates
          pr-number: ${{ github.event.issue.number }}
          pr-sha: ${{ steps.pr-info.outputs.sha }}

          # GitHub token
          github-token: ${{ secrets.GITHUB_TOKEN }}

          # L1 configuration
          l1-chain-id: ${{ secrets.LOCAL_TESTNET_L1_CHAIN_ID }}
          l1-cl-url: ${{ secrets.LOCAL_TESTNET_L1_CL }}
          l1-el-url: ${{ secrets.LOCAL_TESTNET_L1_EL }}

          # Wallet configuration
          wallet-address: ${{ secrets.LOCAL_TESTNET_WALLET_ADDRESS }}
          wallet-private-key: ${{ secrets.LOCAL_TESTNET_WALLET_PK }}
          coordinator-private-key: ${{ secrets.LOCAL_TESTNET_COORDINATOR_PK }}

          # Verifier configuration
          verifier-wallet: ${{ secrets.LOCAL_TESTNET_VERIFIER_WALLET }}
          verifier-key: ${{ secrets.LOCAL_TESTNET_VERIFIER_PK }}

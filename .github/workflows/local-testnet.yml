name: Local Testnet

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:
  run-testnet:
    runs-on: public-isolated
    # Only run if the comment is on a PR, contains /test, and user is org member
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/test') &&
      (github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'OWNER')
    permissions:
      contents: read
      issues: write
      pull-requests: write
      statuses: write
    steps:
      - name: Add reaction to comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: 'rocket'

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Get PR info
        id: pr-info
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}")
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.head.ref')
          COMMIT_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"

      - name: Set status to pending
        run: |
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ steps.pr-info.outputs.sha }}" \
            -d '{
              "state": "pending",
              "description": "Local testnet tests are running...",
              "context": "Local Testnet CI",
              "target_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Inject enhanced GitHub environment variables
        uses: rlespinasse/github-slug-action@v5
      - name: Run local testnet
        run: |
          set -e  # Exit immediately if any command fails
          PWD=`pwd`
          docker run --rm \
             --add-host=host.docker.internal:host-gateway \
             -v /var/run/docker.sock:/var/run/docker.sock \
             -v ${PWD}:/workspace \
             -w /workspace \
             -e HOST_PROJECT_PATH=${PWD} \
             ghcr.io/compose-network/local-testnet:latest l2 \
               --l1-chain-id ${{ secrets.LOCAL_TESTNET_L1_CHAIN_ID }} \
               --l1-cl-url=${{ secrets.LOCAL_TESTNET_L1_CL }} \
               --l1-el-url=${{ secrets.LOCAL_TESTNET_L1_EL}} \
               --wallet-address=${{ secrets.LOCAL_TESTNET_WALLET_ADDRESS}} \
               --wallet-private-key=${{ secrets.LOCAL_TESTNET_WALLET_PK}} \
               --coordinator-private-key=${{ secrets.LOCAL_TESTNET_COORDINATOR_PK }} \
               --genesis-balance-wei=10000000000000000000 \
               --compose-network-name=hoodi \
               --dispute-network-name=hoodi \
               --dispute-owner-address=${{ secrets.LOCAL_TESTNET_WALLET_ADDRESS}} \
               --dispute-proposer-address=${{ secrets.LOCAL_TESTNET_WALLET_ADDRESS}} \
               --dispute-admin-address=${{ secrets.LOCAL_TESTNET_WALLET_ADDRESS}} \
               --dispute-verifier-address=${{ secrets.LOCAL_TESTNET_VERIFIER_WALLET}} \
               --dispute-aggregation-vkey=${{ secrets.LOCAL_TESTNET_VERIFIER_PK}} \
               --compose-contracts-url=https://github.com/compose-network/contracts.git \
               --compose-contracts-branch=develop \
               --publisher-url=https://github.com/compose-network/publisher.git \
               --publisher-branch=${{ steps.pr-info.outputs.branch }} \
               --op-geth-url=https://github.com/compose-network/op-geth.git \
               --op-geth-branch=stage
      - uses: actions/setup-go@v6
        with:
          go-version: '1.25.0'
      - name: Checkout dome test repository
        uses: actions/checkout@v4
        with:
          repository: compose-network/dome
          path: dome

      - name: Parse test pattern from Makefile
        id: parse-tests
        working-directory: dome
        run: |
          # Extract the test pattern from the smoke-test target in the Makefile
          TEST_PATTERN=$(grep -A 5 '^smoke-test:' Makefile | grep -o '\-test\.run="[^"]*"' | sed 's/-test\.run="\(.*\)"/\1/')
          echo "pattern=$TEST_PATTERN" >> "$GITHUB_OUTPUT"
          echo "Extracted test pattern: $TEST_PATTERN"

      - name: Run smoke tests
        id: smoke-tests
        continue-on-error: true
        working-directory: dome
        run: |
          cp ../output.yaml configs/config.yaml
          mkdir -p bin && go test -c ./test/ -o bin/dome
          echo "Running smoke tests with INFO log level..."
          echo "Test pattern from Makefile: ${{ steps.parse-tests.outputs.pattern }}"
          LOG_LEVEL=INFO bin/dome -test.v -test.count=1 -test.run="${{ steps.parse-tests.outputs.pattern }}" 2>&1 | tee test-output.log
          exit ${PIPESTATUS[0]}

      - name: Parse test results and post comment
        if: always() && steps.smoke-tests.outcome != 'skipped'
        working-directory: dome
        run: |
          # Parse test results from the log file
          if [ -f test-output.log ]; then
            echo "## Test Results" > test-summary.md
            echo "" >> test-summary.md

            # Extract test results
            grep -E "^(--- PASS:|--- FAIL:)" test-output.log | while read -r line; do
              if echo "$line" | grep -q "PASS:"; then
                test_name=$(echo "$line" | sed 's/--- PASS: \(.*\) (.*/\1/')
                echo "ðŸŸ¢ **$test_name** - PASS" >> test-summary.md
              elif echo "$line" | grep -q "FAIL:"; then
                test_name=$(echo "$line" | sed 's/--- FAIL: \(.*\) (.*/\1/')
                echo "ðŸ”´ **$test_name** - FAIL" >> test-summary.md
              fi
            done

            # Add workflow run link
            echo "" >> test-summary.md
            echo "---" >> test-summary.md
            echo "ðŸ“Š [View full test logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) - look for the 'Run smoke tests' step of the workflow." >> test-summary.md

            # Post comment to PR
            # Escape the content for JSON by replacing special characters
            COMMENT_BODY=$(sed 's/\\/\\\\/g; s/"/\\"/g; s/$/\\n/g' test-summary.md | tr -d '\n' | sed 's/\\n$//')
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
              -d "{\"body\": \"$COMMENT_BODY\"}"
          else
            echo "No test output file found"
          fi

      - name: Set status to success
        if: steps.smoke-tests.outcome == 'success'
        run: |
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ steps.pr-info.outputs.sha }}" \
            -d '{
              "state": "success",
              "description": "Local testnet tests passed!",
              "context": "Local Testnet CI",
              "target_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'

      - name: Set status to failure
        if: steps.smoke-tests.outcome == 'failure' || failure()
        run: |
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ steps.pr-info.outputs.sha }}" \
            -d '{
              "state": "failure",
              "description": "Local testnet tests failed",
              "context": "Local Testnet CI",
              "target_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'
